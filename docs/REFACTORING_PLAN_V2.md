# üöÄ –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ EatBot v2.0
## –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –∑–∞–º–µ—á–∞–Ω–∏–π

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä –∏ —Ü–µ–ª–∏](#1-–æ–±–∑–æ—Ä-–∏-—Ü–µ–ª–∏)
2. [–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è](#2-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞-—Ç–µ–∫—É—â–µ–≥–æ-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ](#3-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ-—Ä–µ—à–µ–Ω–∏–µ)
4. [–ü–æ—ç—Ç–∞–ø–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#4-–ø–æ—ç—Ç–∞–ø–Ω—ã–π-–ø–ª–∞–Ω-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
5. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏](#5-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—Ä–∏—Å–∫–∞–º–∏)
6. [–ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞](#6-–º–µ—Ç—Ä–∏–∫–∏-—É—Å–ø–µ—Ö–∞)
7. [–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#7-–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è-–∫–ª—é—á–µ–≤—ã—Ö-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
8. [–ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](#8-–ø–ª–∞–Ω-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
9. [–ó–∞–∫–ª—é—á–µ–Ω–∏–µ](#9-–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)

---

## 1. –û–±–∑–æ—Ä –∏ —Ü–µ–ª–∏

### üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏
- **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**: –°–æ–∑–¥–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–π, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- **–£–ª—É—á—à–µ–Ω–∏–µ UX**: –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Å –Ω–∞–¥–µ–∂–Ω—ã–º –º–µ—Ö–∞–Ω–∏–∑–º–æ–º "–ù–∞–∑–∞–¥"
- **–ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏**: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- **–£–ø—Ä–æ—â–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: –ß–µ—Ç–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞ 60%
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∞–≥–æ–≤ –Ω–∞ 80%
- –£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ –Ω–∞ 90%
- –£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–¥–∞ –Ω–∞ 70%

---

## 2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ
- **–ï–¥–∏–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –∫–æ–ª–±—ç–∫–æ–≤** (`main_callback_router.py`) - –æ—Ç–ª–∏—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞
- **–°—Ç–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏** (`NavigationStack`) - —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data** - section:action:params
- **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** - handlers, services, utils

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤**: `product_handlers.py` –∏ `product_handler.py`
2. **–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏**: —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –µ–¥–∏–Ω–æ–π —Ñ–∞–±—Ä–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä**: –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
4. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ConversationHandler**: –Ω–µ—Ç —á–µ—Ç–∫–æ–π —Å–≤—è–∑–∏ —Å —Ä–æ—É—Ç–µ—Ä–æ–º
5. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è callback_data**: –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª–∏–Ω—ã –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### üèóÔ∏è –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] --> B[Telegram Bot]
    B --> C[Main Callback Router]
    C --> D[Section Handlers]
    D --> E[Recipe Handler]
    D --> F[Product Handler]
    D --> G[Navigation Handler]
    D --> H[Main Handler]
    
    E --> I[Recipe Service]
    F --> J[Product Service]
    G --> K[Navigation Stack]
    H --> L[UI Service]
    
    I --> M[Data Service]
    J --> M
    L --> N[Keyboard Factory]
    L --> O[Message Factory]
    
    P[Conversation Handler] --> Q[Recipe Creation Flow]
    P --> R[Product Addition Flow]
    
    style C fill:#e1f5fe
    style G fill:#f3e5f5
    style N fill:#e8f5e8
    style P fill:#fff3e0
```

### üîÑ –ú–µ—Ö–∞–Ω–∏–∑–º –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–î–û–†–ê–ë–û–¢–ê–ù–ù–´–ô)

#### 3.1 –°—Ç–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

```python
class NavigationItem:
    """–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —ç–∫—Ä–∞–Ω–∞"""
    def __init__(self, section: str, action: str, params: Dict[str, Any], 
                 message_text: str, keyboard_type: str, return_point: Optional[str] = None):
        self.section = section
        self.action = action
        self.params = params.copy()
        self.message_text = message_text
        self.keyboard_type = keyboard_type
        self.return_point = return_point  # –î–ª—è ConversationHandler
        self.timestamp = time.time()

class EnhancedNavigationStack:
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"""
    
    def push_screen(self, item: NavigationItem) -> None:
        """–î–æ–±–∞–≤–ª—è–µ—Ç —ç–∫—Ä–∞–Ω –≤ —Å—Ç–µ–∫ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"""
        self.stack.append(item)
        if len(self.stack) > 15:  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç
            self.stack.pop(0)
    
    def get_return_point(self) -> Optional[str]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–ª—è ConversationHandler"""
        return self.stack[-1].return_point if self.stack else None
```

#### 3.2 –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–∫–æ–º

```python
class NavigationManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å—Ç–µ–∫–æ–º"""
    
    async def navigate_to(self, update: Update, context: ContextTypes.DEFAULT_TYPE,
                         section: str, action: str, params: Dict[str, Any],
                         message_text: str, keyboard_type: str) -> None:
        """–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤ —Å—Ç–µ–∫"""
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å—Ç–µ–∫
        if context.user_data.get('current_screen'):
            self.stack.push_screen(context.user_data['current_screen'])
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω
        new_screen = NavigationItem(section, action, params, message_text, keyboard_type)
        context.user_data['current_screen'] = new_screen
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
        await self.show_screen(update, context, new_screen)
    
    async def go_back(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω"""
        previous_screen = self.stack.pop()
        if previous_screen:
            context.user_data['current_screen'] = previous_screen
            await self.show_screen(update, context, previous_screen)
        else:
            await self.go_to_main_menu(update, context)
```

### üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ callback_data (–î–û–†–ê–ë–û–¢–ê–ù–ù–û–ï)

#### 3.3 CallbackDataBuilder —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–ª–∏–Ω—ã

```python
class CallbackDataBuilder:
    """–°—Ç—Ä–æ–∏—Ç–µ–ª—å callback_data —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"""
    
    MAX_LENGTH = 64  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
    
    @classmethod
    def build(cls, section: str, action: str, **params) -> str:
        """–°—Ç—Ä–æ–∏—Ç callback_data —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–ª–∏–Ω—ã"""
        parts = [section, action]
        
        for key, value in params.items():
            if value is not None:
                parts.append(f"{key}={value}")
        
        result = ":".join(parts)
        
        if len(result.encode('utf-8')) > cls.MAX_LENGTH:
            raise ValueError(
                f"Callback data too long ({len(result)} chars): {result}. "
                f"Use CallbackDataBuilder.build_with_id() for complex data."
            )
        
        return result
    
    @classmethod
    def build_with_id(cls, section: str, action: str, data_id: str, **params) -> str:
        """–°—Ç—Ä–æ–∏—Ç callback_data —Å ID –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ data_id –∫–æ—Ä–æ—Ç–∫–∏–π
        if len(data_id) > 20:
            raise ValueError(f"Data ID too long: {data_id}")
        
        return cls.build(section, action, id=data_id, **params)
    
    @classmethod
    def build_pagination(cls, section: str, action: str, page: int, **params) -> str:
        """–°—Ç—Ä–æ–∏—Ç callback_data –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"""
        return cls.build(section, action, page=str(page), **params)
```

#### 3.4 –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```python
class CallbackDataManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–ª–∏–Ω–Ω—ã–º–∏ callback_data"""
    
    def __init__(self):
        self._temp_data: Dict[str, Any] = {}
        self._counter = 0
    
    def store_complex_data(self, data: Any) -> str:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ª–æ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π ID"""
        data_id = f"d{self._counter}_{int(time.time())}"
        self._temp_data[data_id] = data
        self._counter += 1
        return data_id
    
    def get_complex_data(self, data_id: str) -> Optional[Any]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ ID"""
        return self._temp_data.get(data_id)
    
    def cleanup_old_data(self, max_age_hours: int = 24) -> None:
        """–û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ"""
        current_time = time.time()
        expired_ids = [
            data_id for data_id, data in self._temp_data.items()
            if current_time - data.get('timestamp', 0) > max_age_hours * 3600
        ]
        for data_id in expired_ids:
            del self._temp_data[data_id]

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
callback_data_manager = CallbackDataManager()
```

### üó£Ô∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ConversationHandler (–î–û–†–ê–ë–û–¢–ê–ù–ù–ê–Ø)

#### 3.5 –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –∏ –≤—ã—Ö–æ–¥–∞

```python
class ConversationIntegration:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ConversationHandler —Å —Ä–æ—É—Ç–µ—Ä–æ–º"""
    
    @staticmethod
    async def start_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE,
                               conversation_type: str) -> None:
        """–ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–æ—á–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞"""
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∫ —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
        current_screen = context.user_data.get('current_screen')
        if current_screen:
            context.user_data['conversation_return_point'] = {
                'section': current_screen.section,
                'action': current_screen.action,
                'params': current_screen.params,
                'message_text': current_screen.message_text,
                'keyboard_type': current_screen.keyboard_type
            }
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–∏–∞–ª–æ–≥–∞
        context.user_data['in_conversation'] = True
        context.user_data['conversation_type'] = conversation_type
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π ConversationHandler
        if conversation_type == 'recipe_creation':
            await start_recipe_creation_conversation(update, context)
        elif conversation_type == 'product_addition':
            await start_product_addition_conversation(update, context)
    
    @staticmethod
    async def end_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE,
                              success: bool = True) -> None:
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —ç–∫—Ä–∞–Ω—É"""
        
        # –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–∏–∞–ª–æ–≥–∞
        context.user_data.pop('in_conversation', None)
        context.user_data.pop('conversation_type', None)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
        return_point = context.user_data.pop('conversation_return_point', None)
        
        if return_point and success:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —ç–∫—Ä–∞–Ω—É
            await NavigationManager.navigate_to(
                update, context,
                return_point['section'],
                return_point['action'],
                return_point['params'],
                return_point['message_text'],
                return_point['keyboard_type']
            )
        else:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            await NavigationManager.go_to_main_menu(update, context)
```

#### 3.6 –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è ConversationHandler

```python
# –í bot.py - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–∏–∞–ª–æ–≥–æ–≤
async def setup_conversation_handlers(application: Application) -> None:
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–∏–∞–ª–æ–≥–æ–≤"""
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–∏–∞–ª–æ–≥–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞
    async def start_recipe_conversation_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
        await ConversationIntegration.start_conversation(update, context, 'recipe_creation')
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–∏–∞–ª–æ–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
    async def start_product_conversation_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
        await ConversationIntegration.start_conversation(update, context, 'product_addition')
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –¥–∏–∞–ª–æ–≥–∞
    async def cancel_conversation_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
        await ConversationIntegration.end_conversation(update, context, success=False)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–∞–∫ CallbackQueryHandler —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
    application.add_handler(
        CallbackQueryHandler(start_recipe_conversation_handler, pattern="^conversation:start:recipe$"),
        group=1
    )
    application.add_handler(
        CallbackQueryHandler(start_product_conversation_handler, pattern="^conversation:start:product$"),
        group=1
    )
    application.add_handler(
        CallbackQueryHandler(cancel_conversation_handler, pattern="^conversation:cancel$"),
        group=1
    )
```

---

## 4. –ü–æ—ç—Ç–∞–ø–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üßπ –§–∞–∑–∞ 1: –û—á–∏—Å—Ç–∫–∞ (1-2 –¥–Ω—è)

#### –ó–∞–¥–∞—á–∞ 1.1: –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
- **Deliverable**: –£–¥–∞–ª–µ–Ω—ã `product_handlers.py`, `message_handlers.py`
- **Criteria**: –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ `product_handler.py`, `recipe_handler.py`, `main_handler.py`
- **Risk**: –ù–∏–∑–∫–∏–π - —Ñ–∞–π–ª—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ bot.py

#### –ó–∞–¥–∞—á–∞ 1.2: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
- **Deliverable**: –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã –≤ `*_handler.py`
- **Criteria**: –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–µ
- **Risk**: –ù–∏–∑–∫–∏–π - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

#### –ó–∞–¥–∞—á–∞ 1.3: –û—á–∏—Å—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
- **Deliverable**: –£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã
- **Criteria**: –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ª–∏–Ω—Ç–µ—Ä–∞ –æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–º–ø–æ—Ä—Ç–∞—Ö
- **Risk**: –ù–∏–∑–∫–∏–π

### üîß –§–∞–∑–∞ 2: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è (3-4 –¥–Ω—è)

#### –ó–∞–¥–∞—á–∞ 2.1: –°–æ–∑–¥–∞–Ω–∏–µ KeyboardFactory
- **Deliverable**: `src/ui/keyboards/keyboard_factory.py`
- **Criteria**: 
  - –í—Å–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä (inline, reply, custom)
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä
- **Risk**: –°—Ä–µ–¥–Ω–∏–π - –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä

#### –ó–∞–¥–∞—á–∞ 2.2: –°–æ–∑–¥–∞–Ω–∏–µ MessageFactory
- **Deliverable**: `src/ui/messages/message_factory.py`
- **Criteria**:
  - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞–º–∏
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
  - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏
- **Risk**: –ù–∏–∑–∫–∏–π - —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

#### –ó–∞–¥–∞—á–∞ 2.3: –£–ª—É—á—à–µ–Ω–∏–µ CallbackDataBuilder
- **Deliverable**: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `CallbackDataBuilder` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–ª–∏–Ω—ã
- **Criteria**:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã callback_data
  - –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  - –£–¥–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- **Risk**: –ù–∏–∑–∫–∏–π - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

#### –ó–∞–¥–∞—á–∞ 2.4: –£–ª—É—á—à–µ–Ω–∏–µ NavigationHandler
- **Deliverable**: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `NavigationHandler` —Å –ø–æ–ª–Ω—ã–º —Å—Ç–µ–∫–æ–º
- **Criteria**:
  - –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —ç–∫—Ä–∞–Ω–∞—Ö –≤ —Å—Ç–µ–∫–µ
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–∫–æ–º
  - –¢–æ—á–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–ª—è ConversationHandler
- **Risk**: –°—Ä–µ–¥–Ω–∏–π - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

### üé® –§–∞–∑–∞ 3: –ü–æ–ª–∏—Ä–æ–≤–∫–∞ (2-3 –¥–Ω—è)

#### –ó–∞–¥–∞—á–∞ 3.1: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ConversationHandler
- **Deliverable**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ —Å —Ä–æ—É—Ç–µ—Ä–æ–º
- **Criteria**:
  - –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –∏ –≤—ã—Ö–æ–¥–∞ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –¥–∏–∞–ª–æ–≥
  - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ –¥–∏–∞–ª–æ–≥–∞
- **Risk**: –í—ã—Å–æ–∫–∏–π - —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

#### –ó–∞–¥–∞—á–∞ 3.2: –°–æ–∑–¥–∞–Ω–∏–µ CallbackDataManager
- **Deliverable**: `src/utils/callback_data_manager.py`
- **Criteria**:
  - –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
  - –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
- **Risk**: –ù–∏–∑–∫–∏–π - –Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

#### –ó–∞–¥–∞—á–∞ 3.3: –§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞
- **Deliverable**: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `main_callback_router.py`
- **Criteria**:
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–æ–ª–±—ç–∫–æ–≤
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ConversationHandler
  - –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **Risk**: –°—Ä–µ–¥–Ω–∏–π - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏

---

## 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏

### üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏

#### –†–∏—Å–∫ 1: –ù–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
- **–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
- **–í–ª–∏—è–Ω–∏–µ**: –í—ã—Å–æ–∫–æ–µ
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: 
  - –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
  - –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö

#### –†–∏—Å–∫ 2: –ü—Ä–æ–±–ª–µ–º—ã —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
- **–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
- **–í–ª–∏—è–Ω–∏–µ**: –í—ã—Å–æ–∫–æ–µ
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
  - –¢—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  - Fallback –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

#### –†–∏—Å–∫ 3: –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ callback_data
- **–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è
- **–í–ª–∏—è–Ω–∏–µ**: –°—Ä–µ–¥–Ω–µ–µ
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –≤ CallbackDataBuilder
  - –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è callback_data

### üõ°Ô∏è –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ**: Git-–∫–æ–º–º–∏—Ç—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —ç—Ç–∞–ø–æ–º
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–∫–≤–æ–∑–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
4. **–û—Ç–∫–∞—Ç**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–∞—Ç–∞ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏

---

## 6. –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤**: –° 10 –¥–æ 5 (-50%)
2. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞**: –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 30%
3. **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –±–æ—Ç–∞**: –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 20%
4. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–≥–æ–≤**: –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 80%

### üìà –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞**: –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 70%
2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**: –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 60%
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**: –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 90%
4. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏**: –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 95%

---

## 7. –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### üè≠ KeyboardFactory

```python
class KeyboardFactory:
    """–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä"""
    
    _cache: Dict[str, Any] = {}
    
    @classmethod
    def get(cls, keyboard_type: str, **params) -> Any:
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ —Ç–∏–ø—É"""
        cache_key = f"{keyboard_type}:{hash(frozenset(params.items()))}"
        
        if cache_key not in cls._cache:
            cls._cache[cache_key] = cls._create_keyboard(keyboard_type, **params)
        
        return cls._cache[cache_key]
    
    @classmethod
    def _create_keyboard(cls, keyboard_type: str, **params) -> Any:
        """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞"""
        if keyboard_type == "main_menu":
            return cls._create_main_menu_keyboard(**params)
        elif keyboard_type == "recipe_menu":
            return cls._create_recipe_menu_keyboard(**params)
        elif keyboard_type == "products_menu":
            return cls._create_products_menu_keyboard(**params)
        elif keyboard_type == "navigation":
            return cls._create_navigation_keyboard(**params)
        else:
            raise ValueError(f"Unknown keyboard type: {keyboard_type}")
    
    @classmethod
    def _create_main_menu_keyboard(cls, **params) -> InlineKeyboardMarkup:
        """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
        keyboard = [
            [InlineKeyboardButton("üìö –†–µ—Ü–µ–ø—Ç—ã", callback_data=CallbackDataBuilder.build("main", "recipes"))],
            [InlineKeyboardButton("üçè –ü—Ä–æ–¥—É–∫—Ç—ã", callback_data=CallbackDataBuilder.build("main", "products"))],
            [InlineKeyboardButton("ü§ù –°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞", callback_data=CallbackDataBuilder.build("main", "collaborative"))]
        ]
        return InlineKeyboardMarkup(keyboard)
    
    @classmethod
    def clear_cache(cls) -> None:
        """–û—á–∏—â–∞–µ—Ç –∫—ç—à –∫–ª–∞–≤–∏–∞—Ç—É—Ä"""
        cls._cache.clear()
```

### üìù MessageFactory

```python
class MessageFactory:
    """–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π"""
    
    @classmethod
    def get(cls, message_type: str, **params) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ç–∏–ø—É"""
        if message_type == "main_menu":
            return cls._get_main_menu_message(**params)
        elif message_type == "recipe_menu":
            return cls._get_recipe_menu_message(**params)
        elif message_type == "products_menu":
            return cls._get_products_menu_message(**params)
        elif message_type == "error":
            return cls._get_error_message(**params)
        else:
            raise ValueError(f"Unknown message type: {message_type}")
    
    @classmethod
    def _get_main_menu_message(cls, **params) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
        return "üçΩÔ∏è **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ EatBot!**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
    
    @classmethod
    def _get_error_message(cls, error: str = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞", **params) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ"""
        return f"‚ùå **–û—à–∏–±–∫–∞:** {error}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."
```

### üîÑ NavigationManager

```python
class NavigationManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –ø–æ–ª–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å—Ç–µ–∫–æ–º"""
    
    @classmethod
    async def navigate_to(cls, update: Update, context: ContextTypes.DEFAULT_TYPE,
                         section: str, action: str, params: Dict[str, Any],
                         message_text: str, keyboard_type: str) -> None:
        """–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω"""
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        cls._save_current_screen(context)
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω
        new_screen = NavigationItem(section, action, params, message_text, keyboard_type)
        context.user_data['current_screen'] = new_screen
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
        await cls._show_screen(update, context, new_screen)
    
    @classmethod
    async def go_back(cls, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω"""
        navigation_stack = cls._get_navigation_stack(context)
        previous_screen = navigation_stack.pop()
        
        if previous_screen:
            context.user_data['current_screen'] = previous_screen
            await cls._show_screen(update, context, previous_screen)
        else:
            await cls.go_to_main_menu(update, context)
    
    @classmethod
    async def go_to_main_menu(cls, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–µ—Ä–µ—Ö–æ–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
        cls._clear_navigation_stack(context)
        
        await cls.navigate_to(
            update, context,
            "main", "menu", {},
            MessageFactory.get("main_menu"),
            "main_menu"
        )
    
    @classmethod
    def _save_current_screen(cls, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω –≤ —Å—Ç–µ–∫"""
        current_screen = context.user_data.get('current_screen')
        if current_screen:
            navigation_stack = cls._get_navigation_stack(context)
            navigation_stack.push_screen(current_screen)
    
    @classmethod
    def _get_navigation_stack(cls, context: ContextTypes.DEFAULT_TYPE) -> EnhancedNavigationStack:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"""
        if 'navigation_stack' not in context.user_data:
            context.user_data['navigation_stack'] = EnhancedNavigationStack()
        return context.user_data['navigation_stack']
    
    @classmethod
    def _clear_navigation_stack(cls, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û—á–∏—â–∞–µ—Ç —Å—Ç–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"""
        navigation_stack = cls._get_navigation_stack(context)
        navigation_stack.clear()
        context.user_data.pop('current_screen', None)
    
    @classmethod
    async def _show_screen(cls, update: Update, context: ContextTypes.DEFAULT_TYPE, 
                          screen: NavigationItem) -> None:
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω"""
        keyboard = KeyboardFactory.get(screen.keyboard_type, **screen.params)
        
        await ui_service._send_or_edit_message(
            update=update,
            context=context,
            text=screen.message_text,
            reply_markup=keyboard
        )
```

### üîß CallbackDataBuilder (–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

```python
class CallbackDataBuilder:
    """–°—Ç—Ä–æ–∏—Ç–µ–ª—å callback_data —Å –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é"""
    
    MAX_LENGTH = 64  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
    MAX_PARAMS = 10  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    
    @classmethod
    def build(cls, section: str, action: str, **params) -> str:
        """–°—Ç—Ä–æ–∏—Ç callback_data —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"""
        if not section or not action:
            raise ValueError("Section and action are required")
        
        parts = [section, action]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        param_count = 0
        for key, value in params.items():
            if value is not None and param_count < cls.MAX_PARAMS:
                parts.append(f"{key}={value}")
                param_count += 1
        
        result = ":".join(parts)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É
        if len(result.encode('utf-8')) > cls.MAX_LENGTH:
            raise ValueError(
                f"Callback data too long ({len(result)} chars): {result}. "
                f"Use CallbackDataBuilder.build_with_id() for complex data."
            )
        
        return result
    
    @classmethod
    def build_with_id(cls, section: str, action: str, data_id: str, **params) -> str:
        """–°—Ç—Ä–æ–∏—Ç callback_data —Å ID –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        if len(data_id) > 20:
            raise ValueError(f"Data ID too long: {data_id}")
        
        return cls.build(section, action, id=data_id, **params)
    
    @classmethod
    def build_pagination(cls, section: str, action: str, page: int, total_pages: int, **params) -> str:
        """–°—Ç—Ä–æ–∏—Ç callback_data –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"""
        return cls.build(section, action, page=str(page), total=str(total_pages), **params)
    
    @classmethod
    def build_search(cls, section: str, action: str, query: str, **params) -> str:
        """–°—Ç—Ä–æ–∏—Ç callback_data –¥–ª—è –ø–æ–∏—Å–∫–∞"""
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∑–∞–ø—Ä–æ—Å–∞
        if len(query) > 20:
            query = query[:20] + "..."
        
        return cls.build(section, action, q=query, **params)
    
    @classmethod
    def build_filter(cls, section: str, action: str, filter_type: str, filter_value: str, **params) -> str:
        """–°—Ç—Ä–æ–∏—Ç callback_data –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤"""
        return cls.build(section, action, filter=filter_type, value=filter_value, **params)
```

### üó£Ô∏è ConversationIntegration (–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

```python
class ConversationIntegration:
    """–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ConversationHandler —Å —Ä–æ—É—Ç–µ—Ä–æ–º"""
    
    CONVERSATION_TYPES = {
        'recipe_creation': 'recipe_creation_conversation_handler',
        'product_addition': 'product_addition_conversation_handler',
        'recipe_edit': 'recipe_edit_conversation_handler',
        'product_edit': 'product_edit_conversation_handler'
    }
    
    @staticmethod
    async def start_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE,
                               conversation_type: str) -> None:
        """–ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–æ—á–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞"""
        
        if conversation_type not in ConversationIntegration.CONVERSATION_TYPES:
            raise ValueError(f"Unknown conversation type: {conversation_type}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∫ —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
        current_screen = context.user_data.get('current_screen')
        if current_screen:
            context.user_data['conversation_return_point'] = {
                'section': current_screen.section,
                'action': current_screen.action,
                'params': current_screen.params,
                'message_text': current_screen.message_text,
                'keyboard_type': current_screen.keyboard_type,
                'timestamp': time.time()
            }
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–∏–∞–ª–æ–≥–∞
        context.user_data['in_conversation'] = True
        context.user_data['conversation_type'] = conversation_type
        context.user_data['conversation_start_time'] = time.time()
        
        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞
        logger.info(f"Starting conversation: {conversation_type}")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π ConversationHandler
        handler_name = ConversationIntegration.CONVERSATION_TYPES[conversation_type]
        handler = getattr(conversation_handlers, handler_name)
        await handler(update, context)
    
    @staticmethod
    async def end_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE,
                              success: bool = True, result_data: Optional[Dict[str, Any]] = None) -> None:
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —ç–∫—Ä–∞–Ω—É"""
        
        conversation_type = context.user_data.get('conversation_type', 'unknown')
        start_time = context.user_data.get('conversation_start_time', 0)
        duration = time.time() - start_time
        
        # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
        logger.info(f"Ending conversation: {conversation_type}, success: {success}, duration: {duration:.2f}s")
        
        # –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–∏–∞–ª–æ–≥–∞
        context.user_data.pop('in_conversation', None)
        context.user_data.pop('conversation_type', None)
        context.user_data.pop('conversation_start_time', None)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
        return_point = context.user_data.pop('conversation_return_point', None)
        
        if return_point and success:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            if result_data:
                success_message = ConversationIntegration._get_success_message(conversation_type, result_data)
                await ui_service._send_or_edit_message(
                    update=update,
                    context=context,
                    text=success_message,
                    reply_markup=None
                )
                await asyncio.sleep(2)  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥—ã
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —ç–∫—Ä–∞–Ω—É
            await NavigationManager.navigate_to(
                update, context,
                return_point['section'],
                return_point['action'],
                return_point['params'],
                return_point['message_text'],
                return_point['keyboard_type']
            )
        else:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
            cancel_message = ConversationIntegration._get_cancel_message(conversation_type)
            await ui_service._send_or_edit_message(
                update=update,
                context=context,
                text=cancel_message,
                reply_markup=None
            )
            await asyncio.sleep(2)
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            await NavigationManager.go_to_main_menu(update, context)
    
    @staticmethod
    def _get_success_message(conversation_type: str, result_data: Dict[str, Any]) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        if conversation_type == 'recipe_creation':
            recipe_name = result_data.get('name', '–†–µ—Ü–µ–ø—Ç')
            return f"‚úÖ –†–µ—Ü–µ–ø—Ç '{recipe_name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
        elif conversation_type == 'product_addition':
            product_name = result_data.get('name', '–ü—Ä–æ–¥—É–∫—Ç')
            return f"‚úÖ –ü—Ä–æ–¥—É–∫—Ç '{product_name}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!"
        else:
            return "‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    
    @staticmethod
    def _get_cancel_message(conversation_type: str) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ –¥–∏–∞–ª–æ–≥–∞"""
        if conversation_type == 'recipe_creation':
            return "‚ùå –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
        elif conversation_type == 'product_addition':
            return "‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
        else:
            return "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
```

---

## 8. –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### üß™ –î–µ—Ç–∞–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### Happy Path —Ç–µ—Å—Ç—ã

**1. –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∞–º**
- [ ] –ü–µ—Ä–µ—Ö–æ–¥ –≤ "–†–µ—Ü–µ–ø—Ç—ã" –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
- [ ] –ü–µ—Ä–µ—Ö–æ–¥ –≤ "–ü—Ä–æ–¥—É–∫—Ç—ã" –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é  
- [ ] –ü–µ—Ä–µ—Ö–æ–¥ –≤ "–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞" –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
- [ ] –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞

**2. –†–∞–±–æ—Ç–∞ —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏**
- [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤
- [ ] –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤
- [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ

**3. –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏**
- [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- [ ] –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–¥—É–∫—Ç–µ
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫

#### Navigation Path —Ç–µ—Å—Ç—ã

**1. –ì–ª—É–±–æ–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è**
- [ ] –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Üí –†–µ—Ü–µ–ø—Ç—ã ‚Üí –ü–æ–∏—Å–∫ ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç 1 ‚Üí –î–µ—Ç–∞–ª–∏
- [ ] –í–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥ —Å –∫–∞–∂–¥–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å—Ç–µ–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

**2. –ü–µ—Ä–µ–∫—Ä–µ—Å—Ç–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è**
- [ ] –†–µ—Ü–µ–ø—Ç—ã ‚Üí –ü—Ä–æ–¥—É–∫—Ç—ã ‚Üí –†–µ—Ü–µ–ø—Ç—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–µ–∫–∞)
- [ ] –ë—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
- [ ] –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –ª—é–±–æ–≥–æ —ç–∫—Ä–∞–Ω–∞

**3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏**
- [ ] –ë—ã—Å—Ç—Ä–æ–µ –¥–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ "–ù–∞–∑–∞–¥"
- [ ] –ù–∞–∂–∞—Ç–∏–µ "–ù–∞–∑–∞–¥" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
- [ ] –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

#### Edge Cases —Ç–µ—Å—Ç—ã

**1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥**
- [ ] –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞, –∫–æ–≥–¥–∞ –±–æ—Ç –µ–≥–æ –Ω–µ –æ–∂–∏–¥–∞–µ—Ç
- [ ] –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞
- [ ] –ë—ã—Å—Ç—Ä—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫

**2. –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**
- [ ] –î–ª–∏–Ω–Ω—ã–µ callback_data (–ø—Ä–æ–≤–µ—Ä–∫–∞ CallbackDataBuilder)
- [ ] –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
- [ ] –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ Telegram API

**3. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞
- [ ] –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

#### Conversation Path —Ç–µ—Å—Ç—ã

**1. –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞**
- [ ] –ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–∞ –∏–∑ –º–µ–Ω—é —Ä–µ—Ü–µ–ø—Ç–æ–≤
- [ ] –í–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞
- [ ] –í–≤–æ–¥ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
- [ ] –í–≤–æ–¥ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞
- [ ] –û—Ç–º–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ

**2. –î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞**
- [ ] –ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–∞ –∏–∑ –º–µ–Ω—é –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- [ ] –í–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
- [ ] –í–≤–æ–¥ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏
- [ ] –í–≤–æ–¥ –ë–ñ–£
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
- [ ] –û—Ç–º–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ

**3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π**
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –¥–∏–∞–ª–æ–≥
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã
- [ ] –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –æ—à–∏–±–∫–µ

### üîç –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# tests/test_navigation.py
class TestNavigation:
    """–¢–µ—Å—Ç—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"""
    
    async def test_deep_navigation(self):
        """–¢–µ—Å—Ç –≥–ª—É–±–æ–∫–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"""
        # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Üí –†–µ—Ü–µ–ø—Ç—ã ‚Üí –ü–æ–∏—Å–∫ ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç
        await self.navigate_to_recipes()
        await self.navigate_to_search()
        await self.navigate_to_result()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        stack = self.get_navigation_stack()
        assert len(stack) == 3
        assert stack[0]['section'] == 'main'
        assert stack[1]['section'] == 'recipes'
        assert stack[2]['section'] == 'recipes'
    
    async def test_back_navigation(self):
        """–¢–µ—Å—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥"""
        # –°–æ–∑–¥–∞–µ–º –≥–ª—É–±–æ–∫—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        await self.create_deep_navigation()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞–∑–∞–¥
        await self.press_back_button()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω
        current_screen = self.get_current_screen()
        assert current_screen['section'] == 'recipes'
        assert current_screen['action'] == 'search'
    
    async def test_conversation_integration(self):
        """–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –¥–∏–∞–ª–æ–≥–∞–º–∏"""
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await self.navigate_to_recipes()
        initial_screen = self.get_current_screen()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–ª–æ–≥
        await self.start_conversation('recipe_creation')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ—á–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
        return_point = self.get_conversation_return_point()
        assert return_point['section'] == initial_screen['section']
        
        # –û—Ç–º–µ–Ω—è–µ–º –¥–∏–∞–ª–æ–≥
        await self.cancel_conversation()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —ç–∫—Ä–∞–Ω—É
        current_screen = self.get_current_screen()
        assert current_screen['section'] == return_point['section']
```

### üìä –ú–µ—Ç—Ä–∏–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞**
- –¶–µ–ª—å: 90% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å: 100% –ø–æ–∫—Ä—ã—Ç–∏–µ
- –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: 100% –ø–æ–∫—Ä—ã—Ç–∏–µ

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤**
- Unit —Ç–µ—Å—Ç—ã: < 30 —Å–µ–∫—É–Ω–¥
- Integration —Ç–µ—Å—Ç—ã: < 2 –º–∏–Ω—É—Ç
- E2E —Ç–µ—Å—Ç—ã: < 5 –º–∏–Ω—É—Ç

**–ö–∞—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤**
- –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å: –ü–æ–Ω—è—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ò–∑–æ–ª—è—Ü–∏—è: –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å: –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

---

## 9. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### üéØ –ò—Ç–æ–≥–æ–≤—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞ EatBot –ø–æ–ª—É—á–∏—Ç:

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —É—Ä–æ–≤–Ω—è Enterprise**: –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –ª–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
2. **–ù–∞–¥–µ–∂–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é**: –°—Ç–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
3. **–£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏**: CallbackDataBuilder —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. **–ë–µ–∑—É–ø—Ä–µ—á–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –¥–∏–∞–ª–æ–≥–æ–≤**: ConversationHandler –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å —Ä–æ—É—Ç–µ—Ä–æ–º
5. **–í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–±—Ä–∏–∫–∏, –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1 (–û—á–∏—Å—Ç–∫–∞) - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏, –±—ã—Å—Ç—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
2. **–í —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏**: –ó–∞–≤–µ—Ä—à–∏—Ç—å –§–∞–∑—É 2 (–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è) - —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–±—Ä–∏–∫ –∏ —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
3. **–ö –∫–æ–Ω—Ü—É –≤—Ç–æ—Ä–æ–π –Ω–µ–¥–µ–ª–∏**: –ó–∞–≤–µ—Ä—à–∏—Ç—å –§–∞–∑—É 3 (–ü–æ–ª–∏—Ä–æ–≤–∫–∞) - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –∏ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
4. **–ü–æ—Å—Ç–æ—è–Ω–Ω–æ**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ - –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### üí™ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é

–≠—Ç–æ—Ç –ø–ª–∞–Ω —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤–∞—à–∏ –∑–∞–º–µ—á–∞–Ω–∏—è –∏ —Å–æ–∑–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ "–ø—É–ª–µ–Ω–µ–ø—Ä–æ–±–∏–≤–∞–µ–º—É—é" –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É. –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Ä–∏—Å–∫–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ. 

**–ì–æ—Ç–æ–≤ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é!** üéØ

---

*–ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –∑–∞–º–µ—á–∞–Ω–∏–π –∏ –≥–æ—Ç–æ–≤ –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é* 