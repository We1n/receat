# Architecture Plan — Shared Pantry PWA

## 1. Цель проекта

Создать простой, долгосрочный web/PWA-сервис для двух пользователей,
предназначенный для:
- учёта наличия продуктов (есть / нет),
- быстрого понимания, чего нужно докупить,
- синхронной работы на двух устройствах,
- без авторизации, без истории, без аналитики.

Единственный источник истины — сервер.

---

## 2. Ключевые архитектурные принципы

### 2.1 Server-first (обязательно)

- Все изменения сразу пишутся на сервер
- Нет local-first
- Нет offline-режима данных
- Клиент — тонкий, сервер — источник состояния

Причина:
> Два устройства должны всегда видеть одно и то же состояние без конфликтов.

---

### 2.2 Минимальное состояние

- Нет истории
- Нет версий
- Нет ролей
- Последнее действие всегда перезаписывает состояние

---

### 2.3 Ограниченный доступ без авторизации

- Один приватный workspace
- Максимум 2 активных клиента
- Доступ по invite-ссылке
- Остальные пользователи видят только публичную заглушку

---

## 3. Общая схема

```
[PWA Client] ──HTTP/WebSocket──> [API Server] ──> [Database]
↑                               |
└──────────── sync ─────────────┘
```

---

## 4. Workspace Model (ядро системы)

### 4.1 Workspace

Workspace — это изолированное пространство данных для двух пользователей.

Свойства:
- уникальный `workspace_id`
- список продуктов
- список рецептов
- список активных клиентов (max = 2)

Workspace создаётся один раз и живёт постоянно.

---

### 4.2 Client Access (без логина)

- При первом заходе по invite-ссылке:
  - сервер выдаёт `client_token`
  - токен сохраняется в cookie / localStorage
- Сервер хранит список активных `client_token` (макс. 2)
- Если лимит превышен:
  - доступ к данным запрещён
  - показывается заглушка

Это **не авторизация**, а контроль доступа.

---

## 5. Data Models (JSON)

### 5.1 Product

```json
{
  "id": "string",
  "name": "string",
  "category": "string",
  "in_stock": true,
  "quantity": null,
  "unit": null
}
```

Правила:

* `in_stock = false` → продукта нет
* `quantity = null` → количество не указано
* категории фиксированные

---

### 5.2 Recipe

```json
{
  "id": "string",
  "name": "string",
  "product_ids": ["string"],
  "notes": "string | null"
}
```

Рецепты:

* добавляются вручную
* вторичны
* не участвуют в расчётах MVP

---

### 5.3 Workspace State

```json
{
  "workspace_id": "string",
  "products": [Product],
  "recipes": [Recipe],
  "active_clients": ["client_token"]
}
```

---

## 6. API Design (минимальный набор)

### 6.1 Workspace

* `GET /workspace/:id`
* `POST /workspace/:id/join`
* `GET /workspace/:id/state`

---

### 6.2 Products

* `GET /products`
* `POST /products`
* `PATCH /products/:id`
* `DELETE /products/:id`

PATCH используется для:

* изменения `in_stock`
* указания `quantity` или пропуска

---

### 6.3 Recipes

* `GET /recipes`
* `POST /recipes`
* `PATCH /recipes/:id`
* `DELETE /recipes/:id`

---

### 6.4 Export

* `GET /export/json`

Экспортирует весь workspace.

---

## 7. Synchronization Strategy

### 7.1 Обновление данных

* Любое изменение:

  * сразу отправляется на сервер
  * сервер обновляет состояние
  * сервер рассылает обновление всем активным клиентам

Реализация:

* WebSocket или SSE (предпочтительно WebSocket)

---

### 7.2 Конфликты

* Конфликтов нет
* Последний запрос перезаписывает данные
* История не хранится

---

## 8. Client (PWA)

### 8.1 Назначение клиента

* Отображение состояния
* Отправка действий пользователя
* Без бизнес-логики

---

### 8.2 PWA ограничения

* PWA используется только для:

  * ярлыка
  * кеширования интерфейса
* Данные не кешируются
* Offline-режим не поддерживается

---

## 9. UI Structure (MVP)

### Экраны:

1. Public Landing (если нет доступа)
2. Out of Stock (главный экран)
3. In Stock
4. Product Edit (количество / пропуск)
5. Recipes

---

## 10. Категории

* Категории фиксированные
* Хранятся на сервере как enum / config
* Используются только для группировки UI

---

## 11. Non-Goals (осознанно исключено)

* Учёт граммов и точных остатков
* Аналитика
* История изменений
* Роли пользователей
* Интеграции с магазинами
* Уведомления
* Поиск (может быть добавлен позже)

---

## 12. Scalability (ограниченная)

Проект не рассчитан на массовое использование.

Допустимо:

* 1 workspace
* 2 клиента
* десятки продуктов

---

## 13. First Implementation Order

1. Workspace + access control
2. Products API
3. Sync (WebSocket)
4. Minimal UI
5. PWA wrapper
6. JSON export

---

## 14. Критерии корректной реализации

* Два устройства видят изменения мгновенно
* Нет рассинхронизации
* Нет локального состояния, влияющего на данные
* Потеря устройства ≠ потеря данных
* Потеря invite-ссылки = потеря доступа (приемлемо)

---

## 15. Итог

Архитектура предельно простая, устойчивая,
без скрытой сложности и без будущего технического долга.

Любое усложнение возможно **только поверх этого ядра**.







